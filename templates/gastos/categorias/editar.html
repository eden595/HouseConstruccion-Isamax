{% extends "partials/layouts/main.html" %}
{% load static %}

{% include "partials/main.html" %}

{% block meta %}
{% with title="Editar Categoría" %}
{% include "partials/title-meta.html" %}
{% endwith %}
{% endblock %}

{% block content %}
{% with title_sub="Administrador" title="Editar categoría" breadcrumb_parent="Categorías"%}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="card">
  <div class="card-body">
    <form id="categoriaForm" method="post" novalidate data-edit-mode="1">
      {% csrf_token %}
      <div class="row g-3 align-items-end">
        <div class="col-md-6 col-lg-3 shrink-col position-relative mb-4">
          <label class="form-label">Categoría <span class="text-danger">*</span></label>
          {{ form.nombre }}
          {% if form.nombre.errors %}
            {% for error in form.nombre.errors %}
            <small class="text-danger position-absolute" style="top: 100%; left: 0.75rem; font-size: 0.75rem; white-space: nowrap;">
              {{ error }}
            </small>
            {% endfor %}
          {% endif %}
        </div>

        <div class="col-md-4 col-lg-3 shrink-col mb-4">
          <label class="form-label">Creado por</label>
          <input type="text" class="form-control form-control-sm" value="{{ categoria.creado_por|default:'-' }}" readonly>
        </div>

        <div class="col-md-4 col-lg-3 shrink-col mb-4">
          <label class="form-label">Fecha creación</label>
          <input type="date" name="fecha_creacion" class="form-control form-control-sm"
            value="{{ categoria.fecha_creacion|date:'Y-m-d' }}" readonly>
        </div>
      </div>

      <div class="d-flex gap-2 mt-2">
        <button type="submit" class="btn btn-primary px-4">Guardar cambios</button>
        <a href="{% url 'admin_categorias' %}" class="btn btn-outline-secondary px-4" id="categoriaCancelar">Cancelar</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Función de detección de cambios
    if (typeof attachNoChangeSweetAlert === 'function') {
      attachNoChangeSweetAlert({
        form: '#categoriaForm',
        onNoChange: () => {
          window.location.href = "{% url 'admin_categorias' %}";
        }
      });
    }

    const form = document.getElementById('categoriaForm');
    if (form && !form.dataset.bound) {
      form.dataset.bound = '1';
      form.addEventListener('submit', () => {
        // Lógica adicional si fuera necesaria
      });
    }

    // Botón Cancelar con confirmación
    const cancelBtn = document.getElementById('categoriaCancelar');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', (ev) => {
        ev.preventDefault();
        if (typeof Swal === 'undefined') {
          if (confirm('¿Estás seguro que quieres cancelar?')) window.location.href = cancelBtn.href;
          return;
        }
        Swal.fire({
          icon: 'question',
          title: '¿Estás seguro que quieres cancelar?',
          showCancelButton: true,
          confirmButtonText: 'Sí, salir',
          cancelButtonText: 'Seguir editando',
          confirmButtonColor: '#00854d'
        }).then(res => {
          if (res.isConfirmed) window.location.href = cancelBtn.href;
        });
      });
    }

    // SweetAlert para errores - Corregido sin espacios en |length
    {% if form.errors %}
      {% if form.errors|length == 1 and form.nombre.errors %}
        Swal.fire({
          icon: 'error',
          title: 'Error en el Nombre',
          text: '{{ form.nombre.errors.0|escapejs }}',
          confirmButtonText: 'Entendido',
          confirmButtonColor: '#198754' // Verde similar al de tu captura
        });
      {% else %}
        Swal.fire({
          icon: 'error',
          title: 'Error de validación',
          text: 'Existe un error en el formulario ({{ form.errors|length }} errores). Por favor revisa los campos en rojo.',
          confirmButtonText: 'Entendido',
          confirmButtonColor: '#198754'
        });
      {% endif %}
    {% endif %}
  });
</script>
{% endblock %}