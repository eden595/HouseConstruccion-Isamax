{% extends "partials/layouts/main.html" %}

{% load static %}



{% include "partials/main.html" %}



{% block css %}



    <link href="{% static 'css/jquery.dataTables.min.css' %}" rel="stylesheet" />

    <link href="{% static 'css/responsive.dataTables.min.css' %}" rel="stylesheet" />

    <style>

      .modal-backdrop.show { opacity: 0.65; }

      #table_gastos th, #table_gastos td { text-align: left; }

      .foto-preview-frame {

        border: none;

        border-radius: 0;

        background: transparent;

        padding: 0;

        display: flex;

        flex-direction: column;

        align-items: center;

        gap: 0;

        box-shadow: none;

      }



      .foto-preview-img {

        max-width: auto;

        height: auto;

        max-width: 90vw;

        max-height: 90vh;

        object-fit: contain;

        border-radius: 10px;

        box-shadow: 0 10px 22px rgba(0,0,0,0.45);

        background:#0b1020;

      }

      .foto-preview-name {
        display: none !important;
        color:#cdd4e4;
        font-weight:500;
      }



      /* Flechas ocultas en esta vista */
      .foto-nav {
        display: none !important;
      }

      .foto-overlay-meta {
        margin-top: 14px;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
      }



      .foto-overlay-index {
        display: none !important;
      }



      .foto-overlay {

        position: fixed;

        top: 0;

        left: 0;

        right: 0;

        bottom: 0;

        width: 100vw;

        height: 100vh;

        background: rgba(3, 6, 12, 0.82);

        backdrop-filter: blur(6px);

        -webkit-backdrop-filter: blur(6px);

        display: none;

        align-items: center;

        justify-content: center;

        z-index: 9999;

        padding: 0;

        pointer-events: auto;

      }



      .foto-overlay.show { display: flex; }

      .foto-overlay .frame {

        background: transparent;

        border: none;

        border-radius: 0;

        padding: 0;

        box-shadow: none;

        width: auto;

        height: auto;

        margin: auto;

        position: relative;

        display: flex;

        align-items: center;

        justify-content: center;

      }

      .foto-overlay .frame .header {

        position: fixed;

        top: 12px;

        right: 16px;

        border: none;

        padding: 0;

        margin: 0;

        display: flex;

        align-items: center;

        gap: 8px;

        color:#e8edf7;

        z-index: 2;

      }



      .foto-overlay .frame .header span { display: none !important; }

      .foto-overlay .close-btn {

        background: rgba(0,0,0,0.7);

        border: 1px solid #4a90e2;

        color: #e8edf7;

        font-size: 20px;

        line-height: 1;

        cursor: pointer;

        border-radius: 50%;

        width: 38px;

        height: 38px;

        display: inline-flex;

        align-items: center;

        justify-content: center;

      }



    </style>



{% endblock %}



{% block meta %}

  {% with title="RendiciÃ³n de Gastos - Lista" %}

    {% include "partials/title-meta.html" %}

  {% endwith %}

{% endblock %}



{% block content %}

  {% with title_sub="Administrador" title="Rendición de gastos" %}

    {% include "partials/pagetitle.html" %}

  {% endwith %}



  <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mb-3">

    <a href="{% url 'admin_gasto_ingresar' %}" class="btn btn-success text-nowrap px-3">

      <i class="bi bi-plus-lg me-1"></i> Nuevo gasto</a>

    <div class="d-flex align-items-center gap-2" style="max-width: 360px; width: 100%; margin-left: auto;">

      <label class="mb-0 small text-muted">Buscar:</label>

      <input type="text" id="searchGastos" class="form-control form-control-sm" placeholder="Obra, proveedor, tipo" />

    </div>

  </div>

  <div class="card mb-4">

    <div class="card-body">

      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">

        <div class="d-flex align-items-center gap-2">

          <label class="mb-0 small text-muted">Mostrar</label>

          <select id="customLengthGastos" class="form-select form-select-sm" style="max-width: 140px;" aria-label="Cantidad de registros a mostrar">

            <option value="10" selected>10</option>

            <option value="25">25</option>

            <option value="50">50</option>

            <option value="-1">Todos</option>

          </select>

          <span class="small text-muted">registros</span>

        </div>

      </div>

      <div class="table-responsive">

        <table id="table_gastos" class="table align-middle table-striped mb-0">

          <thead class="table-light">

            <tr>

              <th>#</th>

              <th>Obra</th>

              <th>Categorí­a</th>

              <th>Proveedor</th>

              <th>Monto</th>

	            <th>Fecha</th>

              <th>Tipo Doc</th>

              <th>Fotografía</th>

              <th>Acciones</th>

            </tr>

          </thead>

          <tbody>



          {% for g in gastos %}

            <tr>

              <td>{{ forloop.counter }}</td>

              <td>{{ g.obra }}</td>

              <td>{{ g.categoria.nombre }}</td>

              <td>{{ g.proveedor.nombre }}</td>

              <td class="monto" data-raw="{{ g.monto|default_if_none:0 }}"></td>

              <td>{{ g.fecha|date:"Y-m-d" }}</td>

              <td>{{ g.tipo_documento.nombre }}</td>

              <td>

                {% if g.foto %}

                  <div class="d-flex align-items-center">

                    <img

                      src="{{ g.foto.url }}"

                      alt="Foto"

                      class="foto-thumb"

                      data-url="{{ g.foto.url }}"

                      data-nombre="{{ g.foto.name|default_if_none:'' }}"

                      data-photos='{{ g.photos_data_json|escapejs|safe }}'

                      data-index="0"

                      style="width:60px;height:46px;object-fit:cover;border-radius:6px;border:1px solid #2e3548; cursor:pointer;"

                      onerror="this.style.display='none';"

                    >

                  </div>

                {% else %}

                  <span class="text-muted small d-inline-block">Sin foto</span>

                {% endif %}

              </td>

              <td>

                <a class="btn-action-edit" href="{% url 'admin_gasto_editar' g.id %}">Editar</a>

              </td>

            </tr>



          {% endfor %}



          </tbody>

        </table>

      </div>

    </div>

  </div>

  <div id="fotoOverlay" class="foto-overlay" aria-hidden="true">

    <div class="frame">

      <div class="header">

        <span class="fw-semibold">Previsualizaciónn</span>

        <button type="button" class="close-btn" aria-label="Cerrar" title="Cerrar">&times;</button>

      </div>

      <div class="foto-preview-frame">

        <button type="button" class="foto-nav foto-nav-prev" aria-label="Anterior">

          <i class="ri-arrow-left-s-line" style="font-size: 20px;"></i>

        </button>

        <img id="fotoOverlayImg" class="foto-preview-img" src="" alt="Foto">

        <button type="button" class="foto-nav foto-nav-next" aria-label="Siguiente">

          <i class="ri-arrow-right-s-line" style="font-size: 20px;"></i>

        </button>

      </div>

      <div class="foto-overlay-meta">

        <span id="fotoOverlayIndex" class="foto-overlay-index">1 de 1</span>

        <div id="fotoOverlayName" class="foto-preview-name small text-truncate w-100 text-center" style="display:none;" title=""></div>

      </div>

    </div>

  </div>

{% endblock %}



{% block js %}

  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>

  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>

    document.addEventListener('DOMContentLoaded', () => {

      const table = new DataTable('#table_gastos', {

          language: { url: '{% static 'json/es-CL.json' %}' },

          dom: 'rtip',

          columnDefs: [

              { searchable: false, targets: [0,8] },

              { orderable: false, targets: [8] }

          ]

      });



      const formatMontos = () => {

        document.querySelectorAll('#table_gastos tbody td.monto').forEach(td => {

          const raw = parseFloat(td.dataset.raw);

          if (Number.isFinite(raw)) {

            td.textContent = raw.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0, maximumFractionDigits: 0 });

          }

        });

      };



      formatMontos();

      table.on('draw', formatMontos);

      const djangoMessages = [

        {% for message in messages %}

        { level: '{{ message.tags|default:"info" }}', text: '{{ message|escapejs }}' }{% if not forloop.last %},{% endif %}

        {% endfor %}

      ];

      if (djangoMessages.length && typeof Swal !== 'undefined') {

        const last = djangoMessages[djangoMessages.length - 1];

        const lvl = (last.level || '').toLowerCase();

        const icon = lvl.includes('success') ? 'success' : lvl.includes('error') ? 'error' : lvl.includes('warning') ? 'warning' : 'info';

        const defaultTitle = lvl.includes('success') ? 'Ha sido actualizado con ÃÂ©xito.' : last.text || 'Información';

        const defaultText = lvl.includes('info') ? 'No modificaste ningún dato.' : undefined;

        Swal.fire({

          icon,

          title: last.text || defaultTitle,

          text: defaultText,

          position: 'center',

          toast: false,

          showConfirmButton: false,

          timer: 2000

        });

      }



      const searchInput = document.getElementById('searchGastos');

      if (searchInput) {

          searchInput.addEventListener('keyup', () => {

              table.search(searchInput.value.trim()).draw();

          });

      }



      const lengthSelect = document.getElementById('customLengthGastos');

      if (lengthSelect) {

          lengthSelect.addEventListener('change', () => {

              table.page.len(lengthSelect.value).draw();

          });

      }



      const overlayEl = document.getElementById('fotoOverlay');

      const overlayImg = overlayEl ? overlayEl.querySelector('#fotoOverlayImg') : null;

      const overlayName = overlayEl ? overlayEl.querySelector('#fotoOverlayName') : null;

      const overlayIndex = overlayEl ? overlayEl.querySelector('#fotoOverlayIndex') : null;

      const prevNav = overlayEl ? overlayEl.querySelector('.foto-nav.foto-nav-prev') : null;

      const nextNav = overlayEl ? overlayEl.querySelector('.foto-nav.foto-nav-next') : null;

      let overlayPhotos = [];

      let currentPhotoIndex = 0;



      const resetOverflow = () => {

        document.documentElement.style.overflow = '';

        document.body.style.overflow = '';

      };



      const updateOverlayContent = () => {

        const photo = overlayPhotos[currentPhotoIndex] || null;

        if (!photo || !overlayImg) return;

        const docName = (photo.name || 'Documento adjunto').trim();

        overlayImg.style.opacity = '0';

        overlayImg.onload = () => { overlayImg.style.opacity = '1'; };

        overlayImg.onerror = () => {

          overlayImg.src = '';

          overlayImg.alt = '';

          if (overlayName) {

            overlayName.textContent = '';

            overlayName.title = '';

            overlayName.style.display = 'none';

          }

          if (overlayIndex) overlayIndex.textContent = '0 de 0';

          Swal.fire({ icon: 'error', title: 'No se pudo cargar la fotografía', timer: 1800, showConfirmButton: false });

        };

        overlayImg.src = photo.url;

        overlayImg.alt = docName;



        if (overlayName) {

          if (photo.name) {

            overlayName.textContent = docName;

            overlayName.title = docName;

            overlayName.style.display = '';

          } else {

            overlayName.textContent = '';

            overlayName.title = '';

            overlayName.style.display = 'none';

          }

        }

        if (overlayIndex) {

          overlayIndex.textContent = `${currentPhotoIndex + 1} de ${overlayPhotos.length}`;

        }

        const hasMultiple = overlayPhotos.length > 1;

        if (prevNav) prevNav.disabled = !hasMultiple;

        if (nextNav) nextNav.disabled = !hasMultiple;

      };



      const openOverlay = () => {

        if (!overlayEl) return;

        overlayEl.classList.add('show');

        overlayEl.setAttribute('aria-hidden', 'false');

        document.documentElement.style.overflow = 'hidden';

        document.body.style.overflow = 'hidden';

        if (overlayEl.parentNode !== document.body) {

          document.body.appendChild(overlayEl);

        }

      };



      const closeOverlay = () => {

        if (!overlayEl) return;

        overlayEl.classList.remove('show');

        overlayEl.setAttribute('aria-hidden', 'true');

        resetOverflow();

      };



      const changePhotoIndex = (direction) => {

        if (!overlayPhotos.length) return;

        currentPhotoIndex = (currentPhotoIndex + direction + overlayPhotos.length) % overlayPhotos.length;

        updateOverlayContent();

      };



      const showPreview = (photos, startIndex = 0) => {

        const validPhotos = Array.isArray(photos) ? photos.filter(p => p && p.url) : [];

        if (!validPhotos.length) {

          Swal.fire({ icon: 'info', title: 'Sin fotografía', timer: 1800, showConfirmButton: false });

          return;

        }

        overlayPhotos = validPhotos;

        currentPhotoIndex = Math.max(0, Math.min(startIndex, overlayPhotos.length - 1));

        updateOverlayContent();

        openOverlay();

      };



      document.addEventListener('click', (event) => {

        const previewBtn = event.target.closest('.foto-thumb');

        if (!previewBtn) return;

        event.preventDefault();

        event.stopPropagation();

        const photosData = previewBtn.dataset.photos || '';

        let photos = [];

        try {

          photos = JSON.parse(photosData);

        } catch (err) {

          photos = [];

        }

        if (!photos.length) {

          const fallbackUrl = previewBtn.dataset.url || '';

          if (fallbackUrl) {

            photos = [{

              url: fallbackUrl,

              name: previewBtn.dataset.nombre || '',

            }];

          }

        }

        const startIdx = parseInt(previewBtn.dataset.index || '0', 10);

        showPreview(photos, startIdx);

      }, true);



      if (overlayEl) {

        overlayEl.addEventListener('click', (e) => {

          if (e.target === overlayEl) {

            closeOverlay();

          }

        });

        const closeBtn = overlayEl.querySelector('.close-btn');

        if (closeBtn) closeBtn.addEventListener('click', closeOverlay);

        if (prevNav) prevNav.addEventListener('click', () => changePhotoIndex(-1));

        if (nextNav) nextNav.addEventListener('click', () => changePhotoIndex(1));

        document.addEventListener('keydown', (ev) => {

          if (!overlayEl.classList.contains('show')) return;

          if (ev.key === 'Escape') {

            closeOverlay();

          } else if (ev.key === 'ArrowRight') {

            changePhotoIndex(1);

          } else if (ev.key === 'ArrowLeft') {

            changePhotoIndex(-1);

          }

        });

      }

    });



  </script>



{% endblock js %}



