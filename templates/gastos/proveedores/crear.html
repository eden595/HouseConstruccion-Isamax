{% extends "partials/layouts/main.html" %}
{% load static %}

{% include "partials/main.html" %}

{% block meta %}
  {% with title="Nuevo Proveedor" %}
    {% include "partials/title-meta.html" %}
{% endwith %}
{% endblock %}

{% block content %}
  {% with title_sub="Administrador" title="Crear proveedor" breadcrumb_parent="Proveedores"%}
    {% include "partials/pagetitle.html" %}
{% endwith %}

<div class="card">
    <div class="card-body">
        {% if messages %}
          <div class="mb-3">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:'info' }} mb-1" role="alert">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <form id="proveedorForm" method="post" novalidate>
            {% csrf_token %}
            <div class="row g-3 align-items-start">
                <div class="col-md-6 col-lg-3 shrink-col">
                    <label class="form-label">Proveedor <span class="text-danger">*</span></label>
                    {{ form.nombre }}
                    {% for error in form.nombre.errors %}
                        <small class="text-danger d-block">{{ error }}</small>
                    {% endfor %}
                </div>
                <div class="col-md-6 col-lg-3 shrink-col">
                    <label class="form-label">RUT <span class="text-danger">*</span></label>
                    {{ form.rut }}
                    {% for error in form.rut.errors %}
                        <small class="text-danger d-block">{{ error }}</small>
                    {% endfor %}
                </div>
                <div class="col-md-6 col-lg-3 shrink-col">
                    <label class="form-label">Dirección <span class="text-danger">*</span></label>
                    {{ form.direccion }}
                    {% for error in form.direccion.errors %}
                        <small class="text-danger d-block">{{ error }}</small>
                    {% endfor %}
                </div>
                <div class="col-md-6 col-lg-3 shrink-col">
                    <label class="form-label">Teléfono <span class="text-danger">*</span></label>
                    {{ form.telefono }}
                    {% for error in form.telefono.errors %}
                        <small class="text-danger d-block">{{ error }}</small>
                    {% endfor %}
                </div>
                <div class="col-md-4 col-lg-3 shrink-col">
                    <label class="form-label">Creado por</label>
                    <input type="text" class="form-control form-control-sm" value="{{ request.user.get_full_name|default:request.user.username }}" readonly>
                </div>
                <div class="col-md-4 col-lg-3 shrink-col">
                    <label class="form-label">Fecha creación</label>
                    {{ form.fecha_creacion }}
                    {% for error in form.fecha_creacion.errors %}
                        <small class="text-danger d-block">{{ error }}</small>
                    {% endfor %}
                </div>
            </div>
            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary px-4">Guardar</button>
                <a href="{% url 'admin_proveedores' %}" class="btn btn-outline-secondary px-4" id="proveedorCancelar">Cancelar</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('proveedorForm');
  if (form && !form.dataset.bound) {
    form.dataset.bound = '1';
    form.addEventListener('submit', () => {
      const fechaInput = form.querySelector('[name="fecha_creacion"]');
      if (fechaInput && fechaInput.value) {
        const match = fechaInput.value.match(/^(\d{2})-(\d{2})-(\d{4})$/);
        if (match) {
          const [, d, m, y] = match;
          fechaInput.value = `${y}-${m}-${d}`;
        }
      }
    });
  }

  const cancel = document.getElementById('proveedorCancelar');
  if (cancel) {
    cancel.addEventListener('click', (ev) => {
      ev.preventDefault();
      if (typeof Swal === 'undefined') {
        if (confirm('¿Quieres salir sin crear el proveedor?')) {
          window.location.href = cancel.href;
        }
        return;
      }
      Swal.fire({
        icon: 'question',
        title: '¿Seguro que no quieres crear un Proveedor?',
        showCancelButton: true,
        confirmButtonText: 'Sí, salir',
        cancelButtonText: 'Seguir editando'
      }).then(res => {
        if (res.isConfirmed) window.location.href = cancel.href;
      });
    });
  }

  // SweetAlert logic: Specific if single error (Name/RUT), otherwise Generic
  {% if form.errors %}
    {% if form.errors|length == 1 and form.nombre.errors %}
      Swal.fire({
          icon: 'error',
          title: 'Error en el Nombre',
          text: '{{ form.nombre.errors.0|escapejs }}',
          confirmButtonText: 'Entendido'
      });
    {% elif form.errors|length == 1 and form.rut.errors %}
      Swal.fire({
          icon: 'error',
          title: 'Error en el RUT',
          text: '{{ form.rut.errors.0|escapejs }}',
          confirmButtonText: 'Entendido'
      });
    {% elif form.errors|length == 1 and form.direccion.errors %}
      Swal.fire({
          icon: 'error',
          title: 'Error en la Dirección',
          text: '{{ form.direccion.errors.0|escapejs }}',
          confirmButtonText: 'Entendido'
      });
    {% elif form.errors|length == 1 and form.telefono.errors %}
      Swal.fire({
          icon: 'error',
          title: 'Error en el Teléfono',
          text: '{{ form.telefono.errors.0|escapejs }}',
          confirmButtonText: 'Entendido'
      });
    {% else %}
      Swal.fire({
        icon: 'error',
        title: 'Error de validación',
        text: 'Existe un error en el formulario ({{ form.errors|length }} errores). Por favor revisa los campos en rojo.',
        confirmButtonText: 'Entendido'
      });
    {% endif %}
  {% endif %}

});
</script>
{% endblock %}
