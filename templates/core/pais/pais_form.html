{% extends "partials/layouts/main.html" %}
{% load static %}

{% include "partials/main.html" %}

{% block meta %}
  {% with title="Formulario País" %}
    {% include "partials/title-meta.html" %}
  {% endwith %}
{% endblock %}

{% block content %}
  {% with title_sub="Administrador" title=title breadcrumb_parent="Países"%}
    {% include "partials/pagetitle.html" %}
  {% endwith %}

<div class="card">
    <div class="card-body">
        <form id="paisForm" method="post" data-edit-mode="{% if form.instance.pk %}1{% else %}0{% endif %}" novalidate>
            {% csrf_token %}
            <div class="row g-3 align-items-start">
                <div class="col-md-4 col-lg-4 shrink-col">
                    <label class="form-label">País <span class="text-danger">*</span></label>
                    {{ form.nombre }}
                    {% for error in form.nombre.errors %}
                        <small class="text-danger d-block">{{ error }}</small>
                    {% endfor %}
                </div>

                <div class="col-md-4 col-lg-4 shrink-col">
                    <label class="form-label">Creado por</label>
                    <input type="text" class="form-control form-control-sm" value="{{ request.user.get_full_name|default:request.user.username }}" readonly>
                </div>

                <div class="col-md-4 col-lg-4 shrink-col">
                    <label class="form-label">Fecha creación</label>
                    {{ form.fecha_creacion }}
                </div>
            </div>

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary px-4">Guardar</button>
                <a href="{% url 'core:paises_list' %}" class="btn btn-outline-secondary px-4" id="paisCancelar">Cancelar</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const djangoMessages = [
    {% for message in messages %}
    { level: '{{ message.tags|default:"info" }}', text: '{{ message|escapejs }}' }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  if (djangoMessages.length && typeof Swal !== 'undefined') {
    const last = djangoMessages[djangoMessages.length - 1];
    const lvl = (last.level || '').toLowerCase();
    const icon = lvl.includes('success') ? 'success' : lvl.includes('error') ? 'error' : lvl.includes('warning') ? 'warning' : 'info';
    const defaultTitle = lvl.includes('success') ? 'Ha sido actualizado con exito.' : last.text || 'Informacion';
    const defaultText = lvl.includes('info') ? 'No modificaste ningun dato.' : undefined;
    Swal.fire({
      icon,
      title: last.text || defaultTitle,
      text: defaultText,
      position: 'center',
      toast: false,
      showConfirmButton: false,
      timer: 1800
    });
  }

  if (typeof attachNoChangeSweetAlert === 'function') {
    attachNoChangeSweetAlert({
      form: '#paisForm',
      onNoChange: () => {
        window.location.href = "{% url 'core:paises_list' %}";
      }
    });
  }

  const cancel = document.getElementById('paisCancelar');
  if (cancel && !cancel.dataset.bound) {
    cancel.dataset.bound = '1';
    cancel.addEventListener('click', (ev) => {
      ev.preventDefault();
      Swal.fire({
        icon: 'question',
        title: '¿Seguro que no quieres crear un País?',
        showCancelButton: true,
        confirmButtonText: 'Si, salir',
        cancelButtonText: 'Seguir editando'
      }).then(res => { if (res.isConfirmed) window.location.href = "{% url 'core:paises_list' %}"; });
    });
  }

  {% if form.errors %}
    {% if form.errors|length == 1 and form.nombre.errors %}
      Swal.fire({
          icon: 'error',
          title: 'Error en el Nombre',
          text: '{{ form.nombre.errors.0|escapejs }}',
          confirmButtonText: 'Entendido'
      });
    {% else %}
      Swal.fire({
        icon: 'error',
        title: 'Error de validación',
        text: 'Existe un error en el formulario ({{ form.errors|length }} errores). Por favor revisa los campos en rojo.',
        confirmButtonText: 'Entendido'
      });
    {% endif %}
  {% endif %}

});
</script>
{% endblock %}

